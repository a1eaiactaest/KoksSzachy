<!DOCTYPE html>
<html lang="en">
<head>
  <title>KoksSzachy</title>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!---<link rel="stylesheet" type="text/css" href="static/style.css"> ziomy od css tutaj macie wgrane juz-->
  <link rel="stylesheet" type="text/css" href="static/chessboard.min.css">

  <script src="static/jquery.min.js"></script>
  <script src="static/chessboard.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
</head>
<body>
  <div id="board" style="height:600px;width:600px;"></div>
  <p></p>
  <button id='newGameButton' type="button" name="newGameButton" onclick="newGame()">New Game</button>
  <h3><span id="status">White to move</span></h3>
  <form class="from-inline">
    <select class="form-control" id="sel1">
      <option value="5">Depth: 5</option>
      <option value="4">Depth: 4</option>
      <option value="3">Depth: 3</option>
      <option value="2">Depth: 2</option>
      <option value="1">Depth: 1</option>
    </select>
  </form>
  <script type="text/javascript">

    var $SCRIPT_ROOT = "" //"{{ request.script_root|tojson|safe }}";
    var statusEl = $('#status'), fenEl = $('#fen'), pgnEl = $('#pgn');
    var board;
    var game = new Chess()
    
    var onDragStart = function(source, piece, position, orientation){
      if (game.game_over() === true ||
          (game.turn() === 'w' && piece.search(/^b/) !== -1) ||
          (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
        return false;
      }
    };

    // odpala sie za kazdym ruchem
    var onDrop = function(source, target){
      var move = game.move({
        from: source,
        to: target,
        promotion: 'n' // TODO: funkcja na wybor promocji
      });
      if (move === null) return 'snapback';

      updateStatus();
      getResponseMove();
    };

    var onSnapEnd = function(){
      board.position(game.fen());
    };

    var updateStatus = function(){
      var status = '';

      var moveColor = 'White';
      if (game.turn() === 'b'){
        moveColor = 'Black';
      }

      // check for checkmate
      if (game.in_checkmate() === true){
        status = 'Game over, ' + moveColor + ' is in checkm8.';
      }

      // check for draw
      else if (game.in_draw() === true){
        status = 'Game over, draw';
      }

      // nothing of above
      else{
        status = moveColor + ' to move';

        // check whether it's check
        if (game.in_check() === true){
          status += ', ' + moveColor + ' is getting checked :0';
        }
      }

      setStatus(status);
      getLastCapture();
      //createTable();
      //upadteScroll();

      statusEl.html(status);
      fenEl.html(game.fen());
      pgnEl.html(game.pgn());
    };
    
    var config = {
      draggable: true,
      position: 'start',
      onDragStart: onDragStart,
      onDrop: onDrop,
      onSnapEnd: onSnapEnd
    };
    
    var randomResponse = function(){
      fen = game.fen()
      $.get($SCRIPT_ROOT + "/move/" + fen, function(data){
        game.move(data, {sloppy:true});
        upadteStatus();
      })
    }
    
    var getResponseMove = function(){
      var e = document.getElementById("sel1");
      var depth = e.options[e.selectedIndex].value;
      fen = game.fen()
      $.get($SCRIPT_ROOT + "/move/" + depth + "/" + fen, function(data){
        game.move(data, {sloppy:true});
        updateStatus();

        setTimeout(function(){ board.position(game.fen()); }, 100);
      })
    }

    setTimeout(function(){
      board = ChessBoard('board', config);
    }, 0);
      
    setStatus = function(status){
      document.getElementById("status").innerHTML = status;
    }

    var takeBack = function(){
      // TODO: zaimplementowac i podpiac pod guzik jakis
    }

    var newGame = function(){
      game.reset();
      board.start();
      updateStatus();
    }

    var getCapturedPieces = function(){
      var history = game.history({verbose:true});
      for (var i = 0; i < history.length; i++){
        if ("captured" in history[i]){
          console.log(history[i]["captured"]);
        }
      }  
    }

    var getLastCapture = function(){
      var history = game.history({verbose:true});
      var index = history.length-1;

      if (history[index] != undefined && "captured" in history[index]){
        console.log(history[index]["captured"]);
      }
    }

  </script>
</body>
</html>
